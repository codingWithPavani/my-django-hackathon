{% extends 'attendance/base.html' %}
{% load custom_filters %}

{% block content %}
<h1>Teacher Dashboard</h1>

<div class="row">
  <!-- Save Attendance -->
  <div class="col-md-6">
    <div class="card mb-3 p-3">
      <h5>Save Attendance</h5>
      {% if next_student_attendance %}
        <form method="post" action="{% url 'save_attendance' %}">
          {% csrf_token %}
          <div class="mb-2">
            <label class="form-label">Roll Number</label>
            <input class="form-control" name="roll_number" value="{{ next_student_attendance.roll_number }}" readonly>
          </div>
          <div class="mb-2">
            <label class="form-label">Status</label>
            <select name="attendance" class="form-select">
              <option value="Present">Present</option>
              <option value="Absent">Absent</option>
            </select>
          </div>
          <button class="btn btn-primary" type="submit">Save Attendance</button>
        </form>
      {% else %}
        <div class="alert alert-success mb-0">
          ✅ Attendance completed for all students today!
        </div>
      {% endif %}
    </div>
  </div>

  <!-- Save Grade -->
  <div class="col-md-6">
    <div class="card mb-3 p-3">
      <h5>Save Grade</h5>

      <!-- Exam Type Selection -->
      <form method="get" class="mb-3">
        <div class="mb-2">
          <label class="form-label">Exam Type</label>
          <select class="form-select" name="exam_type" onchange="this.form.submit()">
            {% for exam in exam_types %}
              <option value="{{ exam }}" {% if exam == selected_exam_type %}selected{% endif %}>{{ exam }}</option>
            {% endfor %}
          </select>
        </div>
      </form>

      {% if next_student_grade %}
        <form method="post" action="{% url 'save_grade' %}">
          {% csrf_token %}
          <div class="mb-2">
            <label class="form-label">Roll Number</label>
            <input class="form-control" name="roll_number" value="{{ next_student_grade.roll_number }}" readonly>
          </div>
          <div class="mb-2">
            <label class="form-label">Subject</label>
            <input class="form-control" name="subject" value="{{ next_subject }}" readonly>
          </div>
          <div class="mb-2">
            <label class="form-label">Exam Type</label>
            <input class="form-control" name="exam_type" value="{{ selected_exam_type }}" readonly>
          </div>
          <div class="mb-2">
            <label class="form-label">Marks</label>
            <input type="number" class="form-control" name="marks" required>
          </div>
          <button class="btn btn-success" type="submit">Save Grade</button>
        </form>
      {% else %}
        <div class="alert alert-success mb-0">
          ✅ All grades entered for all students for {{ selected_exam_type }}!
        </div>
      {% endif %}
    </div>
  </div>
</div>

<hr>

<h4>Students (Latest Attendance - {{ today }})</h4>
<table class="table table-bordered table-striped">
  <thead class="table-light">
    <tr>
      <th>Roll</th>
      <th>Name</th>
      <th>Latest Attendance</th>
      <th>Mid1</th>
      <th>Mid2</th>
      <th>Semester</th>
    </tr>
  </thead>
  <tbody>
    {% for s in students %}
      <tr>
        <td>{{ s.roll_number }}</td>
        <td>{{ s.user.get_full_name|default:s.user.username }}</td>
        <td>{{ s.attendance_status|default:"N/A" }}</td>

        <!-- Mid1 Grade -->
        <td>
          {% if s.mid1_grade != "N/A" %}
            <span class="
              {% if s.mid1_grade == 'S' or s.mid1_grade == 'A' %}text-success fw-bold{% endif %}
              {% if s.mid1_grade == 'B' %}text-primary fw-bold{% endif %}
              {% if s.mid1_grade == 'C' %}text-warning fw-bold{% endif %}
              {% if s.mid1_grade == 'D' %}text-orange fw-bold{% endif %}
              {% if s.mid1_grade == 'E' %}text-info fw-bold{% endif %}
              {% if s.mid1_grade == 'F' %}text-danger fw-bold{% endif %}
            ">
              {{ s.mid1_grade }}
            </span>
          {% else %}
            <span class="text-muted">No grades</span>
          {% endif %}
        </td>

        <!-- Mid2 Grade -->
        <td>
          {% if s.mid2_grade != "N/A" %}
            <span class="
              {% if s.mid2_grade == 'S' or s.mid2_grade == 'A' %}text-success fw-bold{% endif %}
              {% if s.mid2_grade == 'B' %}text-primary fw-bold{% endif %}
              {% if s.mid2_grade == 'C' %}text-warning fw-bold{% endif %}
              {% if s.mid2_grade == 'D' %}text-orange fw-bold{% endif %}
              {% if s.mid2_grade == 'E' %}text-info fw-bold{% endif %}
              {% if s.mid2_grade == 'F' %}text-danger fw-bold{% endif %}
            ">
              {{ s.mid2_grade }}
            </span>
          {% else %}
            <span class="text-muted">No grades</span>
          {% endif %}
        </td>

        <!-- Semester Grade -->
        <td>
          {% if s.sem_grade != "N/A" %}
            <span class="
              {% if s.sem_grade == 'S' or s.sem_grade == 'A' %}text-success fw-bold{% endif %}
              {% if s.sem_grade == 'B' %}text-primary fw-bold{% endif %}
              {% if s.sem_grade == 'C' %}text-warning fw-bold{% endif %}
              {% if s.sem_grade == 'D' %}text-orange fw-bold{% endif %}
              {% if s.sem_grade == 'E' %}text-info fw-bold{% endif %}
              {% if s.sem_grade == 'F' %}text-danger fw-bold{% endif %}
            ">
              {{ s.sem_grade }}
            </span>
          {% else %}
            <span class="text-muted">No grades</span>
          {% endif %}
        </td>
      </tr>
    {% empty %}
      <tr>
        <td colspan="6" class="text-center">No students yet</td>
      </tr>
    {% endfor %}
  </tbody>
</table>
{% endblock %}